#!/usr/bin/env python

import os
import sys
import time
import random
import subprocess as sub

ALFALFA_VIDEO_DIR = "alfalfa_video_dir_server/"

def check(file_id):
  port = random.randint(60000, 61000)
  httpport = random.randint(61000, 62000)

  proc = None

  try:
    alfalfa_test_vector = ("test_vectors/" + file_id)

    if os.system("../frontend/alfalfa-import %s %s" % (alfalfa_test_vector, ALFALFA_VIDEO_DIR)):
      raise Exception("alfalfa-import failed.")

    server_command = "../frontend/alfalfa-server %s 0.0.0.0:%d 0.0.0.0:%d http://localhost:%d" % (ALFALFA_VIDEO_DIR, port, httpport, httpport)
    proc = sub.Popen(server_command, shell=True, stdin=sub.PIPE)
    time.sleep(2)

    output = sub.check_output("./alfalfa-server-check 0.0.0.0:%d 0 | sha1sum" % port, shell=True).split(" ")[0]

    if output != file_id:
      raise Exception("alfalfa-server-check failed: " + output)

  except Exception as ex:
    print(ex)
    sys.exit(1)

  finally:
    if proc:
      proc.stdin.write( "x\n" )
      time.sleep(1)
      
    os.system("rm -rf %s" % ALFALFA_VIDEO_DIR)

check('04b68b0a642d8285303d2b8884fc374e09d28ae9')
check('075d4eb18cbb2885d57eae5201cafb54bc43acca')
check('07b5eb1e9741d90027c46166eaaff566c6bf934f')

sys.exit(0)
